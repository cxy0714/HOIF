<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Introduction to HOIF: Higher Order Influence Function Estimators for ATE ‚Ä¢ HOIF</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Introduction to HOIF: Higher Order Influence Function Estimators for ATE">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">HOIF</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/hoif-vignette.html">Introduction to HOIF: Higher Order Influence Function Estimators for ATE</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Introduction to HOIF: Higher Order Influence
Function Estimators for ATE</h1>
                        <h4 data-toc-skip class="author">Xingyu
Chen</h4>
            
            <h4 data-toc-skip class="date">2026-01-30</h4>
      

      <div class="hidden name"><code>hoif-vignette.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The <strong>HOIF</strong> package implements Higher Order Influence
Function (HOIF) estimators for Average Treatment Effect (ATE) estimation
in causal inference. This methodology extends the doubly robust (DR)
estimator‚Äîalso known as the Augmented Inverse Propensity Weighted (AIPW)
or Double Machine Learning (DML) estimator‚Äîby systematically accounting
for higher-order bias terms.</p>
<div class="section level3">
<h3 id="background">Background<a class="anchor" aria-label="anchor" href="#background"></a>
</h3>
<p>The HOIF methodology was developed through a series of seminal works
by James M. Robins and collaborators:</p>
<ul>
<li>Robins et al.¬†(2008): <em>Higher order influence functions and
minimax estimation of nonlinear functionals</em>
</li>
<li>Robins et al.¬†(2017): <em>Minimax estimation of a functional on a
structured high-dimensional model</em>
</li>
<li>Liu et al.¬†(2017): <em>Semiparametric regression in the presence of
control variables</em>
</li>
<li>Liu &amp; Li (2023): <em>Stable higher order influence function
estimation</em>
</li>
</ul>
<p>The key idea is to represent the bias of the standard DR estimator as
a sum of higher-order influence functions, which can be estimated and
used to debias the original estimator.</p>
</div>
<div class="section level3">
<h3 id="key-features">Key Features<a class="anchor" aria-label="anchor" href="#key-features"></a>
</h3>
<ul>
<li>
<strong>Flexible basis expansion</strong>: Supports B-splines,
Fourier basis, or raw covariates</li>
<li>
<strong>Multiple inversion methods</strong>: Direct, nonlinear
shrinkage, or corpcor regularization</li>
<li>
<strong>Sample splitting support</strong>: Optional K-fold
cross-fitting to avoid overfitting</li>
<li>
<strong>Dual computational backends</strong>: Fast Python
implementation via <code>ustats</code> package or pure R fallback</li>
<li>
<strong>Orders 2-7</strong>: Computes HOIF estimators up to 7th
order (6th order in pure R mode)</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Install from GitHub (example)</span></span>
<span><span class="co"># devtools::install_github("yourusername/HOIF")</span></span>
<span></span>
<span><span class="co"># Or from CRAN (if published)</span></span>
<span><span class="co"># install.packages("HOIF")</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="quick-start-example">Quick Start Example<a class="anchor" aria-label="anchor" href="#quick-start-example"></a>
</h2>
<p>Let‚Äôs demonstrate the basic usage with a simple simulated
example.</p>
<div class="section level3">
<h3 id="generate-simulated-data">Generate Simulated Data<a class="anchor" aria-label="anchor" href="#generate-simulated-data"></a>
</h3>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">500</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fl">2</span></span>
<span></span>
<span><span class="co"># Generate covariates</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span> <span class="op">*</span> <span class="va">p</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="va">p</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># True propensity score</span></span>
<span><span class="va">true_pi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html" class="external-link">plogis</a></span><span class="op">(</span><span class="fl">0.5</span> <span class="op">*</span> <span class="va">X</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="fl">0.3</span> <span class="op">*</span> <span class="va">X</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Generate treatment</span></span>
<span><span class="va">A</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">1</span>, <span class="va">true_pi</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># True outcome functions</span></span>
<span><span class="va">mu1_true</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">+</span> <span class="fl">0.5</span> <span class="op">*</span> <span class="va">X</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="fl">0.3</span> <span class="op">*</span> <span class="va">X</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">^</span><span class="fl">2</span></span>
<span><span class="va">mu0_true</span> <span class="op">&lt;-</span> <span class="fl">0.3</span> <span class="op">*</span> <span class="va">X</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="fl">0.2</span> <span class="op">*</span> <span class="va">X</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Generate outcomes</span></span>
<span><span class="va">Y</span> <span class="op">&lt;-</span> <span class="va">A</span> <span class="op">*</span> <span class="va">mu1_true</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">A</span><span class="op">)</span> <span class="op">*</span> <span class="va">mu0_true</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># True ATE</span></span>
<span><span class="va">true_ate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">mu1_true</span> <span class="op">-</span> <span class="va">mu0_true</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"True ATE:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">true_ate</span>, <span class="fl">4</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; True ATE: 1.3124</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="estimate-nuisance-functions">Estimate Nuisance Functions<a class="anchor" aria-label="anchor" href="#estimate-nuisance-functions"></a>
</h3>
<p>In practice, these would be estimated using machine learning methods
on a separate sample.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># For this example, we'll use simple linear models</span></span>
<span><span class="co"># (In practice, use cross-fitting with flexible ML methods)</span></span>
<span></span>
<span><span class="va">fit_mu1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">X</span>, subset <span class="op">=</span> <span class="va">A</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">fit_mu0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">X</span>, subset <span class="op">=</span> <span class="va">A</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">fit_pi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">A</span> <span class="op">~</span> <span class="va">X</span>, family <span class="op">=</span> <span class="va">binomial</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Predict nuisance functions</span></span>
<span><span class="va">mu1_hat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit_mu1</span>, newdata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">mu0_hat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit_mu0</span>, newdata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">pi_hat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit_pi</span>, type <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Ensure propensity scores are bounded away from 0 and 1</span></span>
<span><span class="va">pi_hat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmax</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmin</a></span><span class="op">(</span><span class="va">pi_hat</span>, <span class="fl">0.95</span><span class="op">)</span>, <span class="fl">0.05</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="compute-hoif-estimators">Compute HOIF Estimators<a class="anchor" aria-label="anchor" href="#compute-hoif-estimators"></a>
</h3>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Compute HOIF estimators without sample splitting</span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/hoif_ate.html">hoif_ate</a></span><span class="op">(</span></span>
<span>  X <span class="op">=</span> <span class="va">X</span>,</span>
<span>  A <span class="op">=</span> <span class="va">A</span>,</span>
<span>  Y <span class="op">=</span> <span class="va">Y</span>,</span>
<span>  mu1 <span class="op">=</span> <span class="va">mu1_hat</span>,</span>
<span>  mu0 <span class="op">=</span> <span class="va">mu0_hat</span>,</span>
<span>  pi <span class="op">=</span> <span class="va">pi_hat</span>,</span>
<span>  transform_method <span class="op">=</span> <span class="st">"none"</span>,  <span class="co"># Use raw covariates</span></span>
<span>  inverse_method <span class="op">=</span> <span class="st">"direct"</span>,</span>
<span>  m <span class="op">=</span> <span class="fl">5</span>,                       <span class="co"># Compute up to 5th order</span></span>
<span>  sample_split <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  backend <span class="op">=</span> <span class="st">"torch"</span>            <span class="co"># Use Python backend</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># View results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span></span>
<span><span class="co">#&gt; HOIF Estimators for Average Treatment Effect</span></span>
<span><span class="co">#&gt; =============================================</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Estimates by order:</span></span>
<span><span class="co">#&gt;   Order    ATE  HOIF1 HOIF0</span></span>
<span><span class="co">#&gt; 1     2 0.0015 0.0016 2e-04</span></span>
<span><span class="co">#&gt; 2     3 0.0015 0.0017 2e-04</span></span>
<span><span class="co">#&gt; 3     4 0.0015 0.0017 2e-04</span></span>
<span><span class="co">#&gt; 4     5 0.0015 0.0016 2e-04</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Final ATE estimate (highest order): 0.0015</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="visualize-convergence">Visualize Convergence<a class="anchor" aria-label="anchor" href="#visualize-convergence"></a>
</h3>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span></span></code></pre></div>
<p><img src="hoif-vignette_files/figure-html/unnamed-chunk-5-1.png" class="r-plt" alt="" width="672"></p>
</div>
</div>
<div class="section level2">
<h2 id="main-function-hoif_ate">Main Function: <code>hoif_ate()</code><a class="anchor" aria-label="anchor" href="#main-function-hoif_ate"></a>
</h2>
<p>The primary interface for computing HOIF estimators.</p>
<div class="section level3">
<h3 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a>
</h3>
<ul>
<li>
<strong>X</strong>: Covariate matrix
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>√ó</mo><mi>p</mi></mrow><annotation encoding="application/x-tex">n \times p</annotation></semantics></math>)</li>
<li>
<strong>A</strong>: Treatment vector (0 or 1)</li>
<li>
<strong>Y</strong>: Outcome vector</li>
<li>
<strong>mu1, mu0</strong>: Predicted outcomes under treatment and
control</li>
<li>
<strong>pi</strong>: Predicted propensity scores</li>
<li>
<strong>transform_method</strong>: Covariate transformation method
<ul>
<li>
<code>"none"</code>: No transformation (use raw covariates)</li>
<li>
<code>"splines"</code>: B-splines basis expansion</li>
<li>
<code>"fourier"</code>: Fourier basis expansion</li>
</ul>
</li>
<li>
<strong>basis_dim</strong>: Number of basis functions (required if
using splines or Fourier)</li>
<li>
<strong>inverse_method</strong>: Method for Gram matrix inversion
<ul>
<li>
<code>"direct"</code>: Moore-Penrose pseudoinverse</li>
<li>
<code>"nlshrink"</code>: Nonlinear shrinkage (Ledoit-Wolf)</li>
<li>
<code>"corpcor"</code>: Shrinkage via corpcor package</li>
</ul>
</li>
<li>
<strong>m</strong>: Maximum order (2-7 for Python backend, 2-6 for
pure R)</li>
<li>
<strong>sample_split</strong>: Logical; whether to use K-fold
cross-fitting</li>
<li>
<strong>n_folds</strong>: Number of folds for sample splitting</li>
<li>
<strong>backend</strong>: <code>"torch"</code> (default) or
<code>"numpy"</code> for Python backend</li>
<li>
<strong>pure_R_code</strong>: Use pure R implementation (limited to
order 6)</li>
<li>
<strong>seed</strong>: Random seed for reproducibility</li>
</ul>
</div>
<div class="section level3">
<h3 id="return-value">Return Value<a class="anchor" aria-label="anchor" href="#return-value"></a>
</h3>
<p>A list of class <code>"hoif_ate"</code> containing:</p>
<ul>
<li>
<strong>ATE</strong>: Vector of ATE estimates for orders 2 to m</li>
<li>
<strong>HOIF1</strong>: Vector of treatment arm HOIF estimates</li>
<li>
<strong>HOIF0</strong>: Vector of control arm HOIF estimates</li>
<li>
<strong>IIFF1</strong>: Vector of treatment arm incremental
influence function terms</li>
<li>
<strong>IIFF0</strong>: Vector of control arm incremental influence
function terms</li>
<li>
<strong>orders</strong>: Vector of orders (2:m)</li>
<li>
<strong>convergence_data</strong>: Data frame for plotting</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="advanced-usage">Advanced Usage<a class="anchor" aria-label="anchor" href="#advanced-usage"></a>
</h2>
<div class="section level3">
<h3 id="using-basis-expansion">Using Basis Expansion<a class="anchor" aria-label="anchor" href="#using-basis-expansion"></a>
</h3>
<p>For more flexible modeling of covariate relationships:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># B-splines basis</span></span>
<span><span class="va">results_splines</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/hoif_ate.html">hoif_ate</a></span><span class="op">(</span></span>
<span>  X <span class="op">=</span> <span class="va">X</span>, A <span class="op">=</span> <span class="va">A</span>, Y <span class="op">=</span> <span class="va">Y</span>,</span>
<span>  mu1 <span class="op">=</span> <span class="va">mu1_hat</span>, mu0 <span class="op">=</span> <span class="va">mu0_hat</span>, pi <span class="op">=</span> <span class="va">pi_hat</span>,</span>
<span>  transform_method <span class="op">=</span> <span class="st">"splines"</span>,</span>
<span>  basis_dim <span class="op">=</span> <span class="fl">5</span>,        <span class="co"># 5 basis functions per covariate</span></span>
<span>  degree <span class="op">=</span> <span class="fl">3</span>,           <span class="co"># Cubic splines</span></span>
<span>  m <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  sample_split <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Fourier basis</span></span>
<span><span class="va">results_fourier</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/hoif_ate.html">hoif_ate</a></span><span class="op">(</span></span>
<span>  X <span class="op">=</span> <span class="va">X</span>, A <span class="op">=</span> <span class="va">A</span>, Y <span class="op">=</span> <span class="va">Y</span>,</span>
<span>  mu1 <span class="op">=</span> <span class="va">mu1_hat</span>, mu0 <span class="op">=</span> <span class="va">mu0_hat</span>, pi <span class="op">=</span> <span class="va">pi_hat</span>,</span>
<span>  transform_method <span class="op">=</span> <span class="st">"fourier"</span>,</span>
<span>  basis_dim <span class="op">=</span> <span class="fl">4</span>,        <span class="co"># 4 Fourier components per covariate</span></span>
<span>  period <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  m <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  sample_split <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="sample-splitting-cross-fitting">Sample Splitting (Cross-Fitting)<a class="anchor" aria-label="anchor" href="#sample-splitting-cross-fitting"></a>
</h3>
<p>To avoid overfitting bias when using the same data for both nuisance
estimation and HOIF computation:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">results_cf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/hoif_ate.html">hoif_ate</a></span><span class="op">(</span></span>
<span>  X <span class="op">=</span> <span class="va">X</span>, A <span class="op">=</span> <span class="va">A</span>, Y <span class="op">=</span> <span class="va">Y</span>,</span>
<span>  mu1 <span class="op">=</span> <span class="va">mu1_hat</span>, mu0 <span class="op">=</span> <span class="va">mu0_hat</span>, pi <span class="op">=</span> <span class="va">pi_hat</span>,</span>
<span>  transform_method <span class="op">=</span> <span class="st">"none"</span>,</span>
<span>  m <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  sample_split <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  n_folds <span class="op">=</span> <span class="fl">5</span>,          <span class="co"># 5-fold cross-fitting</span></span>
<span>  seed <span class="op">=</span> <span class="fl">42</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="regularized-gram-matrix-inversion">Regularized Gram Matrix Inversion<a class="anchor" aria-label="anchor" href="#regularized-gram-matrix-inversion"></a>
</h3>
<p>For high-dimensional settings or when facing numerical
instability:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Nonlinear shrinkage</span></span>
<span><span class="va">results_nlshrink</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/hoif_ate.html">hoif_ate</a></span><span class="op">(</span></span>
<span>  X <span class="op">=</span> <span class="va">X</span>, A <span class="op">=</span> <span class="va">A</span>, Y <span class="op">=</span> <span class="va">Y</span>,</span>
<span>  mu1 <span class="op">=</span> <span class="va">mu1_hat</span>, mu0 <span class="op">=</span> <span class="va">mu0_hat</span>, pi <span class="op">=</span> <span class="va">pi_hat</span>,</span>
<span>  inverse_method <span class="op">=</span> <span class="st">"nlshrink"</span>,</span>
<span>  m <span class="op">=</span> <span class="fl">5</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># corpcor shrinkage</span></span>
<span><span class="va">results_corpcor</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/hoif_ate.html">hoif_ate</a></span><span class="op">(</span></span>
<span>  X <span class="op">=</span> <span class="va">X</span>, A <span class="op">=</span> <span class="va">A</span>, Y <span class="op">=</span> <span class="va">Y</span>,</span>
<span>  mu1 <span class="op">=</span> <span class="va">mu1_hat</span>, mu0 <span class="op">=</span> <span class="va">mu0_hat</span>, pi <span class="op">=</span> <span class="va">pi_hat</span>,</span>
<span>  inverse_method <span class="op">=</span> <span class="st">"corpcor"</span>,</span>
<span>  m <span class="op">=</span> <span class="fl">5</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="pure-r-backend">Pure R Backend<a class="anchor" aria-label="anchor" href="#pure-r-backend"></a>
</h3>
<p>If the Python environment is not available or for smaller
problems:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">results_pure_r</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/hoif_ate.html">hoif_ate</a></span><span class="op">(</span></span>
<span>  X <span class="op">=</span> <span class="va">X</span>, A <span class="op">=</span> <span class="va">A</span>, Y <span class="op">=</span> <span class="va">Y</span>,</span>
<span>  mu1 <span class="op">=</span> <span class="va">mu1_hat</span>, mu0 <span class="op">=</span> <span class="va">mu0_hat</span>, pi <span class="op">=</span> <span class="va">pi_hat</span>,</span>
<span>  pure_R_code <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  m <span class="op">=</span> <span class="fl">6</span>  <span class="co"># Maximum 6 for pure R</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="mathematical-background">Mathematical Background<a class="anchor" aria-label="anchor" href="#mathematical-background"></a>
</h2>
<div class="section level3">
<h3 id="the-hoif-framework">The HOIF Framework<a class="anchor" aria-label="anchor" href="#the-hoif-framework"></a>
</h3>
<p>The HOIF estimator for ATE is defined as:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi>ùî∏</mi><mi>ùïã</mi><mi>ùîº</mi></mrow><mi>m</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><msup><mover><mi>Œ©</mi><mo accent="true">ÃÇ</mo></mover><mi>a</mi></msup><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msubsup><mrow><mi>‚Ñç</mi><mi>ùïÜ</mi><mi>ùïÄ</mi><mi>ùîΩ</mi></mrow><mi>m</mi><mn>1</mn></msubsup><mo>‚àí</mo><msubsup><mrow><mi>‚Ñç</mi><mi>ùïÜ</mi><mi>ùïÄ</mi><mi>ùîΩ</mi></mrow><mi>m</mi><mn>0</mn></msubsup></mrow><annotation encoding="application/x-tex">
\mathbb{ATE}_m(\hat{\Omega}^a) = \mathbb{HOIF}^1_m - \mathbb{HOIF}^0_m
</annotation></semantics></math></p>
<p>where for each treatment arm
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo>‚àà</mo><mo stretchy="false" form="prefix">{</mo><mn>0</mn><mo>,</mo><mn>1</mn><mo stretchy="false" form="postfix">}</mo></mrow><annotation encoding="application/x-tex">a \in \{0,1\}</annotation></semantics></math>:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mrow><mi>‚Ñç</mi><mi>ùïÜ</mi><mi>ùïÄ</mi><mi>ùîΩ</mi></mrow><mi>m</mi><mi>a</mi></msubsup><mrow><mo stretchy="true" form="prefix">(</mo><msup><mover><mi>Œ©</mi><mo accent="true">ÃÇ</mo></mover><mi>a</mi></msup><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><munderover><mo>‚àë</mo><mrow><mi>j</mi><mo>=</mo><mn>2</mn></mrow><mi>m</mi></munderover><msubsup><mrow><mi>ùïÄ</mi><mi>ùîΩ</mi></mrow><mi>j</mi><mi>a</mi></msubsup><mrow><mo stretchy="true" form="prefix">(</mo><msup><mover><mi>Œ©</mi><mo accent="true">ÃÇ</mo></mover><mi>a</mi></msup><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><munderover><mo>‚àë</mo><mrow><mi>i</mi><mo>=</mo><mn>2</mn></mrow><mi>m</mi></munderover><munderover><mo>‚àë</mo><mrow><mi>j</mi><mo>=</mo><mn>2</mn></mrow><mi>i</mi></munderover><mrow><mo stretchy="true" form="prefix">(</mo><mfrac linethickness="0"><mrow><mi>i</mi><mo>‚àí</mo><mn>2</mn></mrow><mrow><mi>i</mi><mo>‚àí</mo><mi>j</mi></mrow></mfrac><mo stretchy="true" form="postfix">)</mo></mrow><msubsup><mi>ùïå</mi><mi>j</mi><mi>a</mi></msubsup><mrow><mo stretchy="true" form="prefix">(</mo><msup><mover><mi>Œ©</mi><mo accent="true">ÃÇ</mo></mover><mi>a</mi></msup><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
\mathbb{HOIF}^a_m(\hat{\Omega}^a) = \sum_{j=2}^m \mathbb{IF}^a_j(\hat{\Omega}^a) = \sum_{i=2}^m \sum_{j=2}^{i} \binom{i-2}{i-j} \mathbb{U}^a_j(\hat{\Omega}^a)
</annotation></semantics></math></p>
</div>
<div class="section level3">
<h3 id="u-statistics-formulation">U-Statistics Formulation<a class="anchor" aria-label="anchor" href="#u-statistics-formulation"></a>
</h3>
<p>The core computational building block is the U-statistic:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>ùïå</mi><mi>m</mi><mi>a</mi></msubsup><mrow><mo stretchy="true" form="prefix">(</mo><msup><mover><mi>Œ©</mi><mo accent="true">ÃÇ</mo></mover><mi>a</mi></msup><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>‚àí</mi><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow><mi>m</mi></msup><mfrac><mrow><mrow><mo stretchy="true" form="prefix">(</mo><mi>n</mi><mo>‚àí</mo><mi>m</mi><mo stretchy="true" form="postfix">)</mo></mrow><mi>!</mi></mrow><mrow><mi>n</mi><mi>!</mi></mrow></mfrac><munder><mo>‚àë</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mrow><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>i</mi><mn>1</mn></msub><mo>,</mo><mi>‚Ä¶</mi><mo>,</mo><msub><mi>i</mi><mi>m</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>:</mo></mrow></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mrow><msub><mi>i</mi><mn>1</mn></msub><mo>‚â†</mo><mi>‚ãØ</mi><mo>‚â†</mo><msub><mi>i</mi><mi>m</mi></msub></mrow></mtd></mtr></mtable></munder><msubsup><mi>r</mi><msub><mi>i</mi><mn>1</mn></msub><mi>a</mi></msubsup><munderover><mo>‚àè</mo><mrow><mi>s</mi><mo>=</mo><mn>1</mn></mrow><mrow><mi>m</mi><mo>‚àí</mo><mn>1</mn></mrow></munderover><mo stretchy="false" form="prefix">{</mo><msubsup><mi>Z</mi><msub><mi>i</mi><mi>s</mi></msub><mi>‚ä§</mi></msubsup><msup><mover><mi>Œ©</mi><mo accent="true">ÃÇ</mo></mover><mi>a</mi></msup><msubsup><mi>s</mi><msub><mi>i</mi><mrow><mi>s</mi><mo>+</mo><mn>1</mn></mrow></msub><mi>a</mi></msubsup><msub><mi>Z</mi><msub><mi>i</mi><mrow><mi>s</mi><mo>+</mo><mn>1</mn></mrow></msub></msub><mo stretchy="false" form="postfix">}</mo><msubsup><mi>R</mi><msub><mi>i</mi><mi>m</mi></msub><mi>a</mi></msubsup></mrow><annotation encoding="application/x-tex">
\mathbb{U}^a_m(\hat{\Omega}^a) = (-1)^m \frac{(n-m)!}{n!} \sum_{\substack{(i_1, \ldots, i_m) : \\ i_1 \neq \cdots \neq i_m}} r^a_{i_1} \prod_{s=1}^{m-1} \{Z_{i_s}^\top \hat{\Omega}^a s^a_{i_{s+1}} Z_{i_{s+1}}\} R^a_{i_m}
</annotation></semantics></math></p>
<p>where:</p>
<ul>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>s</mi><mi>i</mi><mi>a</mi></msubsup><mo>=</mo><msubsup><mi>A</mi><mi>i</mi><mi>a</mi></msubsup><msup><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>‚àí</mo><msub><mi>A</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mn>1</mn><mo>‚àí</mo><mi>a</mi></mrow></msup></mrow><annotation encoding="application/x-tex">s^a_i = A_i^a (1-A_i)^{1-a}</annotation></semantics></math>
is the treatment indicator</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>r</mi><mi>i</mi><mi>a</mi></msubsup><mo>=</mo><mn>1</mn><mo>‚àí</mo><msubsup><mi>s</mi><mi>i</mi><mi>a</mi></msubsup><mi>/</mi><msup><mi>œÄ</mi><mi>a</mi></msup><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>X</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">r^a_i = 1 - s^a_i / \pi^a(X_i)</annotation></semantics></math>
is the inverse propensity weight residual</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>R</mi><mi>i</mi><mi>a</mi></msubsup><mo>=</mo><msub><mi>Y</mi><mi>i</mi></msub><mo>‚àí</mo><mover><mi>Œº</mi><mo accent="true">ÃÇ</mo></mover><mrow><mo stretchy="true" form="prefix">(</mo><mi>a</mi><mo>,</mo><msub><mi>X</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">R^a_i = Y_i - \hat{\mu}(a, X_i)</annotation></semantics></math>
is the outcome residual</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>Z</mi><mi>i</mi></msub><annotation encoding="application/x-tex">Z_i</annotation></semantics></math>
are the transformed covariates</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mover><mi>Œ©</mi><mo accent="true">ÃÇ</mo></mover><mi>a</mi></msup><annotation encoding="application/x-tex">\hat{\Omega}^a</annotation></semantics></math>
is the inverse weighted Gram matrix</li>
</ul>
</div>
<div class="section level3">
<h3 id="sample-splitting">Sample Splitting<a class="anchor" aria-label="anchor" href="#sample-splitting"></a>
</h3>
<p>When using K-fold cross-fitting, for each fold
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>j</mi><annotation encoding="application/x-tex">j</annotation></semantics></math>:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Training</strong>: Use observations not in fold
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>j</mi><annotation encoding="application/x-tex">j</annotation></semantics></math>
to compute
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msubsup><mover><mi>Œ©</mi><mo accent="true">ÃÇ</mo></mover><mi>j</mi><mi>a</mi></msubsup><annotation encoding="application/x-tex">\hat{\Omega}^a_j</annotation></semantics></math>
</li>
<li>
<strong>Estimation</strong>: Use observations in fold
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>j</mi><annotation encoding="application/x-tex">j</annotation></semantics></math>
with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msubsup><mover><mi>Œ©</mi><mo accent="true">ÃÇ</mo></mover><mi>j</mi><mi>a</mi></msubsup><annotation encoding="application/x-tex">\hat{\Omega}^a_j</annotation></semantics></math>
to compute HOIF</li>
<li>
<strong>Aggregation</strong>: Average across all folds</li>
</ol>
<p>This prevents overfitting and provides valid inference
properties.</p>
</div>
</div>
<div class="section level2">
<h2 id="computational-details">Computational Details<a class="anchor" aria-label="anchor" href="#computational-details"></a>
</h2>
<div class="section level3">
<h3 id="python-backend-ustats">Python Backend (ustats)<a class="anchor" aria-label="anchor" href="#python-backend-ustats"></a>
</h3>
<p>The default backend uses the <code>ustats</code> Python package for
efficient U-statistic computation:</p>
<ul>
<li>Supports PyTorch and NumPy backends</li>
<li>Handles arbitrary order U-statistics</li>
<li>Optimized for memory and speed</li>
</ul>
</div>
<div class="section level3">
<h3 id="pure-r-implementation">Pure R Implementation<a class="anchor" aria-label="anchor" href="#pure-r-implementation"></a>
</h3>
<p>The pure R fallback (<code>pure_R_code = TRUE</code>):</p>
<ul>
<li>Implements orders 2-6 using recursive matrix operations</li>
<li>Uses the <code>SMUT</code> package for fast matrix
multiplication</li>
<li>Removes diagonal contributions to ensure proper degenerate
U-statistics</li>
<li>Suitable for smaller datasets or when Python is unavailable</li>
</ul>
</div>
<div class="section level3">
<h3 id="performance-considerations">Performance Considerations<a class="anchor" aria-label="anchor" href="#performance-considerations"></a>
</h3>
<ul>
<li>
<strong>Sample size</strong>: Pure R is suitable for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>&lt;</mo><mn>1000</mn></mrow><annotation encoding="application/x-tex">n &lt; 1000</annotation></semantics></math>;
Python backend scales better</li>
<li>
<strong>Order</strong>: Higher orders increase computation time
exponentially</li>
<li>
<strong>Basis dimension</strong>: Larger basis increases memory and
computation</li>
<li>
<strong>Cross-fitting</strong>: Multiplies computation by number of
folds</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="practical-recommendations">Practical Recommendations<a class="anchor" aria-label="anchor" href="#practical-recommendations"></a>
</h2>
<div class="section level3">
<h3 id="choosing-the-transformation-method">Choosing the Transformation Method<a class="anchor" aria-label="anchor" href="#choosing-the-transformation-method"></a>
</h3>
<ul>
<li>
<strong>‚Äúnone‚Äù</strong>: Start here for low-dimensional problems
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mo>&lt;</mo><mn>5</mn></mrow><annotation encoding="application/x-tex">p &lt; 5</annotation></semantics></math>)</li>
<li>
<strong>‚Äúsplines‚Äù</strong>: Good for smooth nonlinear
relationships</li>
<li>
<strong>‚Äúfourier‚Äù</strong>: Suitable for periodic patterns or
high-frequency features</li>
</ul>
</div>
<div class="section level3">
<h3 id="choosing-the-order">Choosing the Order<a class="anchor" aria-label="anchor" href="#choosing-the-order"></a>
</h3>
<ul>
<li>Start with order 3-4 for initial analysis</li>
<li>Check convergence plot to see if higher orders are needed</li>
<li>Orders beyond 6 rarely improve estimation in practice</li>
</ul>
</div>
<div class="section level3">
<h3 id="choosing-the-inverse-method">Choosing the Inverse Method<a class="anchor" aria-label="anchor" href="#choosing-the-inverse-method"></a>
</h3>
<ul>
<li>
<strong>‚Äúdirect‚Äù</strong>: Default; works well when
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>&gt;</mo><mo>&gt;</mo><mi>k</mi></mrow><annotation encoding="application/x-tex">n &gt;&gt; k</annotation></semantics></math>
(sample size much larger than basis dimension)</li>
<li>
<strong>‚Äúnlshrink‚Äù</strong>: Use when basis dimension is large
relative to sample size</li>
<li>
<strong>‚Äúcorpcor‚Äù</strong>: Alternative shrinkage method, sometimes
more stable</li>
</ul>
</div>
<div class="section level3">
<h3 id="sample-splitting-1">Sample Splitting<a class="anchor" aria-label="anchor" href="#sample-splitting-1"></a>
</h3>
<ul>
<li>
<strong>Always use</strong> when nuisance functions are estimated on
the same data</li>
<li>2-5 folds typically sufficient</li>
<li>More folds = less bias but higher variance</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="example-complete-workflow">Example: Complete Workflow<a class="anchor" aria-label="anchor" href="#example-complete-workflow"></a>
</h2>
<p>Here‚Äôs a complete example with best practices:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 1. Load data</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="st">"your_data.csv"</span><span class="op">)</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"age"</span>, <span class="st">"income"</span>, <span class="st">"education"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">A</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">$</span><span class="va">treatment</span></span>
<span><span class="va">Y</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">$</span><span class="va">outcome</span></span>
<span></span>
<span><span class="co"># 2. Estimate nuisance functions with cross-fitting</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ecpolley/SuperLearner" class="external-link">SuperLearner</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create folds</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span><span class="va">folds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, length.out <span class="op">=</span> <span class="va">n</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mu1_hat</span> <span class="op">&lt;-</span> <span class="va">mu0_hat</span> <span class="op">&lt;-</span> <span class="va">pi_hat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">k</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">train_idx</span> <span class="op">&lt;-</span> <span class="va">folds</span> <span class="op">!=</span> <span class="va">k</span></span>
<span>  <span class="va">test_idx</span> <span class="op">&lt;-</span> <span class="va">folds</span> <span class="op">==</span> <span class="va">k</span></span>
<span>  </span>
<span>  <span class="co"># Propensity score</span></span>
<span>  <span class="va">fit_pi</span> <span class="op">&lt;-</span> <span class="fu">SuperLearner</span><span class="op">(</span></span>
<span>    Y <span class="op">=</span> <span class="va">A</span><span class="op">[</span><span class="va">train_idx</span><span class="op">]</span>,</span>
<span>    X <span class="op">=</span> <span class="va">X</span><span class="op">[</span><span class="va">train_idx</span>, <span class="op">]</span>,</span>
<span>    family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">binomial</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    SL.library <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SL.glm"</span>, <span class="st">"SL.ranger"</span>, <span class="st">"SL.xgboost"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">pi_hat</span><span class="op">[</span><span class="va">test_idx</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit_pi</span>, <span class="va">X</span><span class="op">[</span><span class="va">test_idx</span>, <span class="op">]</span><span class="op">)</span><span class="op">$</span><span class="va">pred</span></span>
<span>  </span>
<span>  <span class="co"># Outcome regression for treated</span></span>
<span>  <span class="va">fit_mu1</span> <span class="op">&lt;-</span> <span class="fu">SuperLearner</span><span class="op">(</span></span>
<span>    Y <span class="op">=</span> <span class="va">Y</span><span class="op">[</span><span class="va">train_idx</span> <span class="op">&amp;</span> <span class="va">A</span><span class="op">[</span><span class="va">train_idx</span><span class="op">]</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span>,</span>
<span>    X <span class="op">=</span> <span class="va">X</span><span class="op">[</span><span class="va">train_idx</span> <span class="op">&amp;</span> <span class="va">A</span><span class="op">[</span><span class="va">train_idx</span><span class="op">]</span> <span class="op">==</span> <span class="fl">1</span>, <span class="op">]</span>,</span>
<span>    SL.library <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SL.glm"</span>, <span class="st">"SL.ranger"</span>, <span class="st">"SL.xgboost"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">mu1_hat</span><span class="op">[</span><span class="va">test_idx</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit_mu1</span>, <span class="va">X</span><span class="op">[</span><span class="va">test_idx</span>, <span class="op">]</span><span class="op">)</span><span class="op">$</span><span class="va">pred</span></span>
<span>  </span>
<span>  <span class="co"># Outcome regression for control</span></span>
<span>  <span class="va">fit_mu0</span> <span class="op">&lt;-</span> <span class="fu">SuperLearner</span><span class="op">(</span></span>
<span>    Y <span class="op">=</span> <span class="va">Y</span><span class="op">[</span><span class="va">train_idx</span> <span class="op">&amp;</span> <span class="va">A</span><span class="op">[</span><span class="va">train_idx</span><span class="op">]</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span>,</span>
<span>    X <span class="op">=</span> <span class="va">X</span><span class="op">[</span><span class="va">train_idx</span> <span class="op">&amp;</span> <span class="va">A</span><span class="op">[</span><span class="va">train_idx</span><span class="op">]</span> <span class="op">==</span> <span class="fl">0</span>, <span class="op">]</span>,</span>
<span>    SL.library <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SL.glm"</span>, <span class="st">"SL.ranger"</span>, <span class="st">"SL.xgboost"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">mu0_hat</span><span class="op">[</span><span class="va">test_idx</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit_mu0</span>, <span class="va">X</span><span class="op">[</span><span class="va">test_idx</span>, <span class="op">]</span><span class="op">)</span><span class="op">$</span><span class="va">pred</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Trim propensity scores</span></span>
<span><span class="va">pi_hat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmax</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmin</a></span><span class="op">(</span><span class="va">pi_hat</span>, <span class="fl">0.95</span><span class="op">)</span>, <span class="fl">0.05</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 3. Compute HOIF estimators</span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/hoif_ate.html">hoif_ate</a></span><span class="op">(</span></span>
<span>  X <span class="op">=</span> <span class="va">X</span>,</span>
<span>  A <span class="op">=</span> <span class="va">A</span>,</span>
<span>  Y <span class="op">=</span> <span class="va">Y</span>,</span>
<span>  mu1 <span class="op">=</span> <span class="va">mu1_hat</span>,</span>
<span>  mu0 <span class="op">=</span> <span class="va">mu0_hat</span>,</span>
<span>  pi <span class="op">=</span> <span class="va">pi_hat</span>,</span>
<span>  transform_method <span class="op">=</span> <span class="st">"splines"</span>,</span>
<span>  basis_dim <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  inverse_method <span class="op">=</span> <span class="st">"nlshrink"</span>,</span>
<span>  m <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  sample_split <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  n_folds <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  seed <span class="op">=</span> <span class="fl">123</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 4. Examine results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 5. Extract final estimate</span></span>
<span><span class="va">final_ate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">results</span><span class="op">$</span><span class="va">ATE</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Final ATE estimate:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">final_ate</span>, <span class="fl">4</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="troubleshooting">Troubleshooting<a class="anchor" aria-label="anchor" href="#troubleshooting"></a>
</h2>
<div class="section level3">
<h3 id="python-backend-issues">Python Backend Issues<a class="anchor" aria-label="anchor" href="#python-backend-issues"></a>
</h3>
<p>If you encounter errors with the Python backend:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Switch to pure R implementation</span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/hoif_ate.html">hoif_ate</a></span><span class="op">(</span></span>
<span>  X <span class="op">=</span> <span class="va">X</span>, A <span class="op">=</span> <span class="va">A</span>, Y <span class="op">=</span> <span class="va">Y</span>,</span>
<span>  mu1 <span class="op">=</span> <span class="va">mu1_hat</span>, mu0 <span class="op">=</span> <span class="va">mu0_hat</span>, pi <span class="op">=</span> <span class="va">pi_hat</span>,</span>
<span>  pure_R_code <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  m <span class="op">=</span> <span class="fl">6</span>  <span class="co"># Limited to order 6</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="numerical-instability">Numerical Instability<a class="anchor" aria-label="anchor" href="#numerical-instability"></a>
</h3>
<p>If you see warnings about matrix inversion:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Try shrinkage methods</span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/hoif_ate.html">hoif_ate</a></span><span class="op">(</span></span>
<span>  X <span class="op">=</span> <span class="va">X</span>, A <span class="op">=</span> <span class="va">A</span>, Y <span class="op">=</span> <span class="va">Y</span>,</span>
<span>  mu1 <span class="op">=</span> <span class="va">mu1_hat</span>, mu0 <span class="op">=</span> <span class="va">mu0_hat</span>, pi <span class="op">=</span> <span class="va">pi_hat</span>,</span>
<span>  inverse_method <span class="op">=</span> <span class="st">"nlshrink"</span>  <span class="co"># or "corpcor"</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="extreme-propensity-scores">Extreme Propensity Scores<a class="anchor" aria-label="anchor" href="#extreme-propensity-scores"></a>
</h3>
<p>Always trim propensity scores to avoid numerical issues:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Trim to [0.05, 0.95]</span></span>
<span><span class="va">pi_hat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmax</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmin</a></span><span class="op">(</span><span class="va">pi_hat</span>, <span class="fl">0.95</span><span class="op">)</span>, <span class="fl">0.05</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<ol style="list-style-type: decimal">
<li><p>Robins, J. M., Li, L., Tchetgen, E. T., &amp; van der Vaart, A.
(2008). Higher order influence functions and minimax estimation of
nonlinear functionals. <em>Probability and Statistics: Essays in Honor
of David A. Freedman</em>, 335-421.</p></li>
<li><p>Robins, J. M., Li, L., Mukherjee, R., Tchetgen Tchetgen, E.,
&amp; van der Vaart, A. (2017). Minimax estimation of a functional on a
structured high-dimensional model. <em>Annals of Statistics</em>, 45(5),
1951-1987.</p></li>
<li><p>Liu, L., Mukherjee, R., &amp; Robins, J. M. (2017).
Semiparametric regression in the presence of control variables.
<em>Electronic Journal of Statistics</em>, 11(2), 3612-3682.</p></li>
<li><p>Liu, L., &amp; Li, L. (2023). Stable higher order influence
function estimation. <em>arXiv preprint</em>.</p></li>
</ol>
</div>
<div class="section level2">
<h2 id="session-info">Session Info<a class="anchor" aria-label="anchor" href="#session-info"></a>
</h2>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; R version 4.5.2 (2025-10-31 ucrt)</span></span>
<span><span class="co">#&gt; Platform: x86_64-w64-mingw32/x64</span></span>
<span><span class="co">#&gt; Running under: Windows 11 x64 (build 26200)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Matrix products: default</span></span>
<span><span class="co">#&gt;   LAPACK version 3.12.1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; locale:</span></span>
<span><span class="co">#&gt; [1] LC_COLLATE=Chinese (Simplified)_China.utf8 </span></span>
<span><span class="co">#&gt; [2] LC_CTYPE=Chinese (Simplified)_China.utf8   </span></span>
<span><span class="co">#&gt; [3] LC_MONETARY=Chinese (Simplified)_China.utf8</span></span>
<span><span class="co">#&gt; [4] LC_NUMERIC=C                               </span></span>
<span><span class="co">#&gt; [5] LC_TIME=Chinese (Simplified)_China.utf8    </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; time zone: Asia/Shanghai</span></span>
<span><span class="co">#&gt; tzcode source: internal</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; attached base packages:</span></span>
<span><span class="co">#&gt; [1] stats     graphics  grDevices utils     datasets  methods   base     </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; other attached packages:</span></span>
<span><span class="co">#&gt; [1] HOIF_0.1.0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; loaded via a namespace (and not attached):</span></span>
<span><span class="co">#&gt;  [1] cli_3.6.5         knitr_1.51        rlang_1.1.7       xfun_0.56        </span></span>
<span><span class="co">#&gt;  [5] otel_0.2.0        png_0.1-8         textshaping_1.0.4 jsonlite_2.0.0   </span></span>
<span><span class="co">#&gt;  [9] SMUT_1.1          rprojroot_2.1.1   htmltools_0.5.9   ragg_1.5.0       </span></span>
<span><span class="co">#&gt; [13] sass_0.4.10       rmarkdown_2.30    grid_4.5.2        evaluate_1.0.5   </span></span>
<span><span class="co">#&gt; [17] jquerylib_0.1.4   MASS_7.3-65       fastmap_1.2.0     yaml_2.3.12      </span></span>
<span><span class="co">#&gt; [21] lifecycle_1.0.5   compiler_4.5.2    RSpectra_0.16-2   fs_1.6.6         </span></span>
<span><span class="co">#&gt; [25] htmlwidgets_1.6.4 Rcpp_1.1.1        here_1.0.2        rstudioapi_0.18.0</span></span>
<span><span class="co">#&gt; [29] lattice_0.22-7    systemfonts_1.3.1 digest_0.6.39     R6_2.6.1         </span></span>
<span><span class="co">#&gt; [33] reticulate_1.44.1 ustats_0.1.0      Matrix_1.7-4      bslib_0.9.0      </span></span>
<span><span class="co">#&gt; [37] withr_3.0.2       SPAtest_3.1.2     SKAT_2.2.5        tools_4.5.2      </span></span>
<span><span class="co">#&gt; [41] pkgdown_2.2.0     cachem_1.1.0      desc_1.4.3</span></span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Xingyu Chen, Lin Liu.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

      </footer>
</div>






  </body>
</html>
